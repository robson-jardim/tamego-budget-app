service cloud.firestore {
    match /databases/{database}/documents {

        match /users/{userId} {
            allow get: if request.auth.uid == userId;
        }

        match /budgets/{budgetId} {

            // Cannot use get() when references the current document
            allow read: if resource.data.userId == request.auth.uid && isAuthorized();
            allow create, update: if request.auth.uid == request.resource.data.userId && isAuthorized();

            match /payees/{payeeId} {
                allow read, create, update: if isBudgetOwner();
            }

            // TODO - set proper permissions for rules
            match /accounts/{accountId} {
                allow read, create, update: if isBudgetOwner();
                //Don't allow direct delete, must delete dependencies first
            }

            match /transactions/{transactionId} {
                allow read, write: if isBudgetOwner();
                //Don't allow delete, splits are tied to transaction
            }

            match /transferTransactions/{transferId} {
                allow read, write: if isBudgetOwner();
            }

            match /categoryGroups/{groupId} {
                allow read, create, update: if isBudgetOwner();
                //Don't allow delete, categories are tied to group
            }

            match /categories/{categoryId} {
                allow read, create, update: if isBudgetOwner();
                //Don't allow delete, transactions are tied to category
            }

            match /categoryValues/{categoryValueId} {
                allow read: if isBudgetOwner();
                allow create: if isBudgetOwner() && validateValueSchema();
                allow update: if isBudgetOwner() && validateValueSchema() && isEditingTime() && !isEditingCategoryId();
                allow delete: if isBudgetOwner();

                function isEditingTime() {
                    return request.resource.data.budgetMonth != resource.data.budgetMonth;
                }

                function isEditingCategoryId() {
                    return request.resource.data.categoryId != resource.data.categoryId;
                }

                function validateValueSchema() {
                    return request.resource.data.keys().hasAll(['budgeted', 'offset', 'categoryId', 'budgetMonth'])
                        && request.resource.data.size() == 4
                        && request.resource.data.budgeted is number
                        && request.resource.data.offset is number
                        && request.resource.data.categoryId is string
                        && request.resource.data.budgetMonth is timestamp
                }
            }

            function isBudgetOwner() {
                return get(/databases/$(database)/documents/budgets/$(budgetId)).data.userId == request.auth.uid;
            }

            function isAuthorizedUser() {
                 return (isAnonymous() && !isExpired()) || isPremium();
            }

            function isPremium() {
                return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.premium == true;
            }

            function isAnonymous() {
                return request.auth.token.firebase.sign_in_provider == 'anonymous';
            }

            function isExpired() {
                // Only allow 2 week old anonymous user accounts
                return request.time >= get(/databases/$(database)/documents/users/$(request.auth.uid)).data.timeCreated + duration.value(2, 'w');
            }
        }
    }
}
