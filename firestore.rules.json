service cloud.firestore {
  match /databases/{database}/documents {
    // match /{document=**} {
    //   allow read, write: if request.auth != null;
    // }
    
    // match /budgets/{budget} {
    // 	allow read, write: if exists(/database/$(database)/documents/users/$(request.auth.uid))
    // }
    
    match /users/{userId} {
    	allow create: if request.auth.uid == userId 
        && request.resource.data.userId == userId 
        && isUserSchemaCorrect();

			allow get: if request.auth.uid == userId;
      
      allow update: if request.auth.uid == userId 
        && request.resource.data.userId == resource.data.userId
        && isUserSchemaCorrect();
    }
    
	// test deploy
    function isUserSchemaCorrect() {
    		return request.resource.data.keys().hasAll(['userId', 'email'])
        	&& request.resource.data.size() == 2
    }
  }
}
